// ==UserScript==
// @name         SOOP 밴허브 정보 출력
// @namespace    https://www.sooplive.co.kr/
// @version      1.2
// @description  유저 팝업에 밴허브 제재 정보 표시 및 바로가기 버튼 추가
// @match        https://play.sooplive.co.kr/*
// @icon         https://www.google.com/s2/favicons?sz=64&domain=play.sooplive.co.kr
// @grant        none
// @updateURL    https://raw.githubusercontent.com/life1spotato/autopsy/refs/heads/main/autopsy.js
// @downloadURL  https://raw.githubusercontent.com/life1spotato/autopsy/refs/heads/main/autopsy.js
// @license MIT
// ==/UserScript==

!function(){"use strict";const t="https://autopsy.life1spotato.workers.dev/?url=",n="https://banhub.xyz/soop/user/",e={normal:"#e0e0e0",warning:"#ffa502",danger:"#ff4757",loading:"#b0b0b0",noData:"#a4b0be",timePeriod:"#a5b1c2",timeout:"#ff7f50"};async function o(o,a,s,r){const c=new AbortController,i=Date.now()+s,l=()=>{const t=Math.max(0,Math.ceil((i-Date.now())/1e3)),n=a.querySelector(".countdown");n&&(n.textContent=t,n.style.color=t<=3?e.timeout:e.loading)},u=r?"재시도":"조회";a.innerHTML=`⏳ ${u} 중... (<span class="countdown" style="color:${e.loading}">${Math.ceil(s/1e3)}</span>초)`;const d=setInterval(l,250);l();const p=setTimeout((()=>{clearInterval(d),c.abort()}),s);try{const e=await async function(e,o){const a=`${n}${e}`,s=`${t}${encodeURIComponent(a)}`,r=await fetch(s,{headers:{"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/108.0.0.0 Safari/537.36"},signal:o});if(!r.ok)throw new Error(404===r.status?"User not found":`Fetch failed with status ${r.status}`);const c=await r.text();if(!c.includes("banhub"))throw new Error("Invalid response from server");const i=function(t){const n=t.match(/<span class="text-2xl font-bold">(\d+)<\/span>.*강제 퇴장/s),e=t.match(/<span class="text-2xl font-bold">(\d+)<\/span>.*채팅 금지/s);return{forcedExit:n?n[1]:"0",chatBan:e?e[1]:"0"}}(c),l=function(t){const n=new Date;n.setDate(n.getDate()-7),n.setHours(0,0,0,0);const e=t.match(/<div class="[^"]*bg-neutral-950[^"]*"[^>]*>.*?<\/div>/gs)||[],o=[];for(const t of e){const e=t.match(/<span class="text-neutral-400[^>]*>(\d{2}\.\d{2}\.\d{2})<\/span>/);if(!e)continue;const[a,s]=e,[r,c,i]=s.split("."),l=new Date(`20${r}-${c}-${i}`);if(l.setHours(0,0,0,0),l>=n){const n=t.match(/<span class="whitespace-nowrap"[^>]*>([^<]+)<\/span>/),e=t.match(/<span class="font-medium"[^>]*>([^<]+)<\/span>/);o.push({date:l,banType:n?n[1].trim():"알 수 없음",streamer:e?e[1].trim():"알 수 없음"})}}return o.sort(((t,n)=>n.date-t.date))}(c);return{last24Hours:i,recentBans:l}}(o,c.signal);return clearTimeout(p),clearInterval(d),e}catch(t){throw clearTimeout(p),clearInterval(d),t}}function a(t,{last24Hours:n={},recentBans:o=[]},a){const s=parseInt(n.forcedExit||"0")>0||parseInt(n.chatBan||"0")>0,r=o.length>0;let c="",i="";if(s){const t=parseInt(n.forcedExit||"0"),o=parseInt(n.chatBan||"0");c+=`<span style="color:${e.timePeriod}">🚨 24시간</span>: `,o>0&&(c+=`<span style="color:${e.warning}">채금 ${o}회</span>`),o>0&&t>0&&(c+=" | "),t>0&&(c+=`<span style="color:${e.danger}">강퇴 ${t}회</span>`),i+=`최근 24시간\n- 채금: ${o}회\n- 강퇴: ${t}회\n`}if(r){s&&(c+="\n");const t=new Date,n=o.reduce(((t,n)=>(n.banType.includes("강퇴")?t.forcedExit++:n.banType.includes("채금")&&t.chatBan++,t)),{forcedExit:0,chatBan:0});c+=`<span style="color:${e.timePeriod}">📉 7일</span>: `,n.chatBan>0&&(c+=`<span style="color:${e.warning}">채금 ${n.chatBan}회</span>`),n.chatBan>0&&n.forcedExit>0&&(c+=" | "),n.forcedExit>0&&(c+=`<span style="color:${e.danger}">강퇴 ${n.forcedExit}회</span>`),i+="\n최근 7일 제재 이력:\n",i+=o.map((n=>{const e=t-n.date;return`[${Math.floor(e/864e5)}일전] ${n.streamer} - ${n.banType}`})).join("\n")}s||r||(c="✅ 제재 이력 없음"),t.innerHTML=c,t.title=i,t.style.textAlign="left",t.style.whiteSpace="pre",t.style.lineHeight="1.4"}new MutationObserver((t=>{t.forEach((t=>{t.addedNodes.forEach((t=>{1===t.nodeType&&t.classList?.contains("chatIct-card")&&async function(t){const s=function(t){const n=t.getAttribute("user_id");return n?n.replace(/\(\d+\)/g,""):null}(t);if(!s)return;const r=t.querySelector(".menu-list");if(!r)return;!function(t){const n=t.querySelector("#banInfoButton");n&&n.parentElement.remove()}(t);const{button:c,listItem:i}=function(t,n){const o=document.createElement("button");o.id="banInfoButton",o.type="button",o.style.cssText=`\n            white-space: pre;\n            text-align: left;\n            padding: 6px 12px;\n            width: 100%;\n            font-size: 12px;\n            cursor: pointer;\n            color: ${e.loading};\n            border: none;\n            background: none;\n            line-height: 1.4;\n            min-height: 36px;\n            display: block;\n        `,o.textContent="🔍 검색 중...";const a=document.createElement("li");return a.appendChild(o),t.insertBefore(a,t.firstChild),{button:o,listItem:a}}(r);!function(t,e){t.addEventListener("click",(t=>{t.stopPropagation(),window.open(`${n}${e}`,"_blank")}))}(c,s);try{a(c,await o(s,c,1e4,!1),s)}catch(t){console.log("첫 시도 실패, 재시도 진행:",t);try{c.innerHTML='🔄 재시도 중... (<span style="color:'+e.timeout+'">10</span>초)';a(c,await o(s,c,1e4,!0),s)}catch(t){console.log("재시도 실패:",t),function(t,n){"User not found"===n.message?(t.style.color=e.noData,t.textContent="✅ 데이터 없음",t.title="해당 사용자의 제재 정보가 없습니다 (클릭시 밴허브 페이지로 이동)"):"AbortError"===n.name?(t.style.color=e.timeout,t.textContent="⌛ 시간 초과",t.title="요청 시간이 초과되었습니다. 네트워크 상태를 확인하세요 (클릭시 밴허브 페이지로 이동)"):(t.style.color=e.warning,t.textContent="⚠️ 조회 실패",t.title=`밴허브 정보를 불러오지 못했습니다: ${n.message} (클릭시 밴허브 페이지로 이동)`)}(c,t)}}}(t)}))}))})).observe(document.body,{childList:!0,subtree:!0})}();
