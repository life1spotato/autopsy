// ==UserScript==
// @name         SOOP 밴허브 정보 출력
// @namespace    https://www.sooplive.co.kr/
// @version      1.1
// @description  유저 팝업에 밴허브 제재 정보 표시 및 바로가기 버튼 추가
// @match        https://play.sooplive.co.kr/*
// @icon         https://www.google.com/s2/favicons?sz=64&domain=play.sooplive.co.kr
// @grant        none
// @updateURL    https://raw.githubusercontent.com/life1spotato/autopsy/refs/heads/main/autopsy2.js
// @downloadURL  https://raw.githubusercontent.com/life1spotato/autopsy/refs/heads/main/autopsy2.js
// @license MIT
// ==/UserScript==

!function(){"use strict";const t="https://autopsy.life1spotato.workers.dev/?url=",e="https://banhub.xyz/soop/user/",n={normal:"#e0e0e0",warning:"#ffa502",danger:"#ff4757",loading:"#b0b0b0",link:"#4dabf7",noData:"#a4b0be",timePeriod:"#a5b1c2"};function o(t){const e=t.querySelectorAll(".text-2xl.font-bold");return{forcedExit:e[1]?.textContent.trim()||"0",chatBan:e[2]?.textContent.trim()||"0"}}function r(t){const e=new Date;return e.setDate(e.getDate()-7),e.setHours(0,0,0,0),Array.from(t.querySelectorAll(".bg-neutral-950, .dark\\:bg-neutral-900")).map((t=>{const n=t.querySelector(".text-neutral-400:not(.inline-block)");if(!n)return null;const o=n.textContent.trim();if(!/^\d{2}\.\d{2}\.\d{2}$/.test(o))return null;const[r,a,s]=o.split("."),i=new Date(`20${r}-${a}-${s}`);return i.setHours(0,0,0,0),i>=e?{date:i,banType:t.querySelector(".whitespace-nowrap")?.textContent.trim()||"알 수 없음",streamer:t.querySelector(".font-medium")?.textContent.trim()||"알 수 없음"}:null})).filter(Boolean).sort(((t,e)=>e.date-t.date))}new MutationObserver((a=>{a.forEach((a=>{a.addedNodes.forEach((a=>{1===a.nodeType&&a.classList?.contains("chatIct-card")&&async function(a){const s=function(t){const e=t.getAttribute("user_id");return e?e.replace(/\(\d+\)/g,""):null}(a);if(!s)return;const i=a.querySelector(".menu-list");if(!i)return;!function(t){const e=t.querySelector("#banInfoButton");e&&e.parentElement.remove()}(a);const{button:c,listItem:l}=function(t,e){const o=document.createElement("button");o.id="banInfoButton",o.type="button",o.style.cssText=`\n            white-space: pre;\n            text-align: left;\n            padding: 6px 12px;\n            width: 100%;\n            font-size: 12px;\n            cursor: pointer;\n            color: ${n.loading};\n            border: none;\n            background: none;\n            line-height: 1.4;\n            min-height: 36px;\n            display: block;\n        `,o.textContent="🔍 검색 중...";const r=document.createElement("li");return r.appendChild(o),t.insertBefore(r,t.firstChild),{button:o,listItem:r}}(i);!function(t,n){t.addEventListener("click",(t=>{t.stopPropagation(),window.open(`${e}${n}`,"_blank")}))}(c,s);try{const a=await async function(n){try{const a=`${e}${n}`,s=`${t}${encodeURIComponent(a)}`,i=await fetch(s,{headers:{"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/108.0.0.0 Safari/537.36"}});if(!i.ok)throw new Error(404===i.status?"User not found":`Fetch failed with status ${i.status}`);const c=await i.text();if(!c.includes("banhub"))throw new Error("Invalid response from server");const l=(new DOMParser).parseFromString(c,"text/html");return{last24Hours:o(l),recentBans:r(l)}}catch(t){throw console.error("Failed to fetch ban info:",t),t}}(s);!function(t,{last24Hours:e={},recentBans:o=[]},r){const a=parseInt(e.forcedExit||"0")>0||parseInt(e.chatBan||"0")>0,s=o.length>0;let i="",c="";if(a){const t=parseInt(e.forcedExit||"0"),o=parseInt(e.chatBan||"0");i+=`<span style="color:${n.timePeriod}">🚨 24시간</span>: `,o>0&&(i+=`<span style="color:${n.warning}">채금 ${o}회</span>`),o>0&&t>0&&(i+=" | "),t>0&&(i+=`<span style="color:${n.danger}">강퇴 ${t}회</span>`),c+=`최근 24시간\n- 채금: ${o}회\n- 강퇴: ${t}회\n`}if(s){a&&(i+="\n");const t=new Date,e=o.reduce(((t,e)=>(e.banType.includes("강퇴")?t.forcedExit++:e.banType.includes("채금")&&t.chatBan++,t)),{forcedExit:0,chatBan:0});i+=`<span style="color:${n.timePeriod}">📉 7일</span>: `,e.chatBan>0&&(i+=`<span style="color:${n.warning}">채금 ${e.chatBan}회</span>`),e.chatBan>0&&e.forcedExit>0&&(i+=" | "),e.forcedExit>0&&(i+=`<span style="color:${n.danger}">강퇴 ${e.forcedExit}회</span>`),c+="\n최근 7일 제재 이력:\n",c+=o.map((e=>{const n=t-e.date;return`[${Math.floor(n/864e5)}일전] ${e.streamer} - ${e.banType}`})).join("\n")}a||s||(i="✅ 제재 이력 없음");t.innerHTML=i,t.title=c,t.style.textAlign="left",t.style.whiteSpace="pre",t.style.lineHeight="1.4"}(c,a)}catch(t){!function(t,e){"User not found"===e.message?(t.style.color=n.noData,t.textContent="✅ 데이터 없음",t.title="해당 사용자의 제재 정보가 없습니다 (클릭시 밴허브 페이지로 이동)"):(t.style.color=n.warning,t.textContent="⚠️ 조회 실패",t.title="밴허브 정보를 불러오지 못했습니다 (클릭시 밴허브 페이지로 이동)")}(c,t),console.error("Error:",t)}}(a)}))}))})).observe(document.body,{childList:!0,subtree:!0})}();
